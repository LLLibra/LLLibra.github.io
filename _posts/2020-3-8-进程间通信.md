---
layout: post
title:  "进程间通信"
data: 星期五, 08. 三月 2020 01:29下午 
categories: 操作系统
tags: 专题
---
* 该模块会针对操作系统中的某一块知识做专题整理，也许会有些不足或者错误的地方，未来可能会作修改。

#  操作系统专题3----进程间通信IPC

## 通信简介
1.通信根据是否通过中间缓存分为直接通信和间接通信，通过是否阻塞也可分，阻塞的分为通过，非阻塞被认为是异步的。


## 信号
信号是Unix系统中使用的最古老的进程间通信的方法之一。操作系统通过信号来通知进程系统中发生了某种预先规定好的事件（一组事件中的一个），它也是用户进程之间通信和同步的一种原始机制。一个键盘中断或者一个错误条件（比如进程试图访问它的虚拟内存中不存在的位置等）都有可能产生一个信号。

#### 信号事件主要有两个来源：
![](imgs/20200310-223205.png)

#### 优点

轻量级快速

#### 实现方式
1.应用程序在程序开始前先要注册一个handler（处理函数），当操作系统获得某个信号的时候就会用这个函数处理。

2.操作系统收到信号，当时正在内核态，操作系统将从内核态到用户态的返回入口改为处理函数的入口，同时也要把信号处理函数之后我们要去的地方修改好，即被打断的地方。（这一步都需要修改堆栈，我们一般不会这么做，病毒会这么做）




## 管道/匿名管道/无名管道（PIPE）
管道通信方式的中间介质是文件，通常称这种文件为管道文件。

管道是半双工，数据只能向一个方向流动；双方需要互相通信时，需要建立起两个管道。

管道的通信方式为：写端每次都将数据写入管道缓冲区的**末尾**
，而读端每次都从管道缓冲区的**头部**读出数据。

#### 实现原理
管道的实质是内核利用**环形队列**的数据结构在
** 内核缓冲区 **中的一个实现

当缓冲区读空或者写满时，有一定的规则控制相应的读进程或者写进程进入等待队列，当空的缓冲区有新数据写入或者满的缓冲区有数据读出来时，就唤醒等待队列中的进程继续读写。

>
管道具体实现进程间通信过程
>
父进程创建管道，得到两个⽂件描述符指向管道的两端
>
父进程fork出子进程，⼦进程继承父进程的文件描述符表，也有两个⽂件描述符指向同⼀管道。
>
父进程关闭fd[0],子进程关闭fd[1]，即⽗进程关闭管道读端,⼦进程关闭管道写端（因为管道只支持单向通信）。⽗进程可以往管道⾥写,⼦进程可以从管道⾥读,管道是⽤环形队列实现的,数据从写端流⼊从读端流出,这样就实现了进程间通信。

#### 缺点
1.只能在具有亲缘关系的进程间通信，

2.只能单向传输数据，另外管道的缓冲区是有限的

3.没有名称

## 命名管道（FIFO）
FIFO可以在无关的进程之间交换数据甚至跨越一个网络的不同计算机的不同进程之间,但是仍旧是半双工的，也是一种文件类型。

仍需要满足 先入先出的原则

命名管道不同于匿名管道之处在于它提供了一个路径名与之关联，以命名管道的文件形式存在于文件系统中，这样，即使与命名管道的创建进程不存在亲缘关系的进程，只要可以访问该路径，就能够彼此通过命名管道相互通信，因此，通过命名管道不相关的进程也能交换数据。

#### 优点

1.有名管道克服了管道没有名字的限制，

2.它还允许无亲缘关系进程间的通信；

#### 缺点
仍是字节流不是结构化数据

## 消息队列
消息队列是存放在内核中的消息链表，每个消息队列由消息队列标识符表示。

消息通信方式以消息缓冲区为中间介质，通信双方的发送和接收操作均以消息为单位。在存储器中，消息缓冲区被组织成队列，通常称之为消息队列。

消息队列存放在内核中，只有在内核重启(即，操作系统重启)或者显示地删除一个消息队列时，该消息队列才会被真正的删除。

消息队列是一种异步的服务间通信方式

![](imgs/20200310-223542.png)

#### 优点： 
1.解耦

如下场景，A系统要发送数据给BCD三个系统。如果新增E系统要调用A系统呢？如果过一段时间C系统不需要了呢？A系统负责人几乎要崩溃了，这是只要将A系统的数据传入消息队列就行



2.通过异步处理提高系统性能，也有削峰的作用
>
在不使用消息队列服务器的时候，用户的请求数据直接写入数据库，在高并发的情况下数据库压力剧增，使得响应速度变慢。但是在使用消息队列之后，用户的请求数据发送给消息队列之后立即 返回，再由消息队列的消费者进程从消息队列中获取数据，异步写入数据库。由于消息队列服务器处理速度快于数据库（消息队列也比数据库有更好的伸缩性），因此响应速度得到大幅改善。



#### 缺点：
1.系统可用性降低

系统引入的外部依赖越多，越容易挂掉。本来你就是 A 系统调用 BCD 三个系统的接口就好了，人 ABCD 四个系统好好的，没啥问题，你偏加个 MQ 进来，万一 MQ 挂了咋整，MQ 一挂，整套系统崩溃的，你不就完了？

2.系统复杂度提高

硬生生加个 MQ 进来，你怎么保证消息没有重复消费？怎么处理消息丢失的情况？怎么保证消息传递的顺序性？头大头大，问题一大堆，痛苦不已。

3.一致性问题

A 系统处理完了直接返回成功了，人都以为你这个请求就成功了；但是问题是，要是 BCD 三个系统那里，BD 两个系统写库成功了，结果 C 系统写库失败了，咋整？你这数据就不一致了。

![](imgs/20200308-204921.png)

####消息列队为什么优于有名管道
1.消息队列提供有格式字节流

2.消息队列还有消息优先级，接收程序可以通过消息类型有选择地接收数据，而不是像命名管道中那样，只能默认地接收。

3.消息队列也可以独立于发送和接收进程而存在，从而消除了在同步命名管道的打开和关闭时可能产生的困难。

## 共享内存

采用共享内存通信的一个显而易见的好处是效率高，因为进程可以直接读写内存，而不需要任何数据的拷贝。** 对于像管道和消息队列等通信方式，则需要在内核和用户空间进行四次的数据拷贝，而共享内存则只拷贝两次数据：一次从输入文件到共享内存区，另一次从共享内存区到输出文件。 **实际上，进程之间在共享内存时，并不总是读写少量数据后就解除映射，有新的通信时，再重新建立共享内存区域。而是保持共享区域，直到通信完毕为止，这样，数据内容一直保存在共享内存中，并没有写回文件。共享内存中的内容往往是在解除映射时才写回文件的。因此，采用共享内存的通信方式效率是非常高的。

原理就是多个进程使用的虚拟地址指向同一个物理内存，对于一个共享内存的同步互斥，实现采用的是引用计数的原理。

>
![](imgs/20200310-223901.png)

#### 优点：
共享内存针对消息缓冲的缺点改而利用内存缓冲区直接交换信息，无须复制，快捷、信息量大是其优点。(其他三种方式都会有大小限制)

#### 缺点：
1.需要额外的同步机制应对竞争

2.因为内存在一台计算机中，所以只能是一台计算机的多个进程。

#### 实现方式
实现方式：通过将同一块物理内存映射到不同的地址空间，这样不同的虚地址就可以访问到一个地址

## socket套接字
套接字是网络编程的api，通过套接字可以不同的机器间的进程进行通信，常用于客户端进程和服务器进程的通信。


## 残留问题

FIFO和消息队列的差别有多少


![](imgs/20200321-144349.png)

